---
title: Neo's Fun - Введение в Reverse-engineering
---

# **Введение в reverse-engineering**
## **Низкоуровневое программирование**

**Регистр** — небольшой объем быстрой памяти, размещенной на процессоре. Предназначен для хранения результатов промежуточных вычислений, а также некоторой информации для управления работой процессора.

### **Регистры общего назначения:**
1. **%eax**: Accumulator register - аккумулятор. Применяется для хранения результатов промежуточных вычислений.

2. **%ebx**: Base register — базовый регистр. Применяется для хранения адреса (указателя) на некоторый объект в памяти.

3. **%ecx**: Counter register — счетчик. Неявно используется некоторыми командами для организации циклов.

4. **%edx**: Data register — регистр данных. Используется для хранения результатов промежуточных вычислений и ввода-вывода.

5. **%esp**: Stack pointer register — указатель стека. Содержит адрес вершины стека.

6. **%ebp**: Base pointer register — указатель базы кадров стека. Предназначен для организации произвольного доступа к данным внутри стека.

7. **%esi**: Source index register — индекс источника. В цепочечных операциях содержит указатель на текущий элемент-источник.

8. **%edi**: Destination index register — индекс приемника. В цепочечных операциях содержит указатель на текущий элемент-приемник.


### **Сегментные регистры:**
1. **%cs**: Code segment — описывает текущий сегмент кода.

2. **%ds**: Data segment — описывает текущий сегмент данных.

3. **%ss**: Stack segment - описывает текущий сегмент стека.

4. **%es**: Extra segment — дополнительный сегмент, используется неявно в строковых командах как сегмент-получатель.

5. **%fs**: F segment — дополнительный сегментный регистр без специального назначения.

6. **%gs**: G segment - дополнительный сегментный регистр без специального назначения.


### Регистры флагов:
1. **cf**: Carry flag — флаг переноса:
    * 1 — во время арифметической операции был произведен перенос из старшего бита результата.
    * 0 — переноса не было.
2. **zf**: Zero flag — флаг нуля:
    * 1 — результат последней операции нулевой.
    * 0 — результат последней операции ненулевой
3. **of**: Overflow flag — флаг переполнения:
    * 1 — во время арифметической операции произошел перенос в/из старшего (знакового) бита результата.
    * 0 — переноса не было.
4. **df**: Direction flag — флаг направления (указывает направление просмотра в строковых операциях):
    * 1 — направление «назад» (от старших адресов к младшим).
    * 0 — направление «вперед» (от младших адресов к старшим).
5. **pf**: Parity flag - флаг четности:
    * 1 - младший байт результата предыдущей команды содержит четное количество бит.
    * 0 - количество единиц в младшем байте нечетное.


**Стек** - структура данных, работающая по принципу LIFO ("Первый пришел - последний вышел"). Неотъемлемая часть архитектуры процессора. Используется для сохранения адресов возврата и передачи аргументов при вызове функций, а также для хранения локальных переменных и значений регистров.  

### **Команды ассемблера**
_Примечание: для описания команд использовался синтаксис AT&T_
#### **Команды пересылки и обмена:**
1. `MOV источник назначение` — копирование источника в назначение
2. `LEA источник назначение` - помещение адреса источника в назначение

#### **Арифметические операции:**
1. `ADD источник приемник` - сложение источника с приемником
2. `SUB источник приемник` - вычитание источника из приемника
3. `MUL множитель %eax` - умножение множителя на сомножитель, который находится в регистре %eax  
4. `INC операнд` - инкремент (увеличение на 1)
5. `DEC операнд` — декремент (уменьшение на 1)

#### **Логические операции:**
1. `AND источник приемник` - логическое И
2. `OR источник приемник` - логическое ИЛИ
3. `XOR источник приемник` - логическое ИЛИ НЕ
4. `NOT операнд` - логическая инверсия
5. `TEST операнд1 операнд2` - логическое И, результат не записывает, влияет на флаги ZF, SF, PF.

#### **Команды безусловных переходов:**
1. `JMP адрес` - безусловный переход по указанному адресу

#### **Команды условных переходов:**
1. `JE/JNE адреc` - переход на указанный адрес, если равно или не равно
2. `JZ/JNZ адрес` - переход на указанный адрес, если равно / не равно 0
3. `JG адрес` - переход на указанный адрес ,если ZF = 0 или SF = OF

#### **Команды работы со стеком:**
1. `PUSH источник` - поместить в стек
2. `POP назначение` - извлечь из стека


## **Структура ELF**
1. **ELF header**: содержит общее описание структуры файла и его основные характеристики: тип, версия формата, архитектура процессора и т. д.

2. **Program header**: содержит информацию, необходимую операционной системе для подготовки программы к исполнению.

3. **Section header**: содержит информацию, необходимую компоновщику для оптимального размещения данных секций по сегментам при сборке файлов.

4. **Содержимое секций и сегментов:**
    * .text — исполняемый код
    * .data — инициализируемые глобальные переменные
    * .bss — неинициализируемые глобальные переменные
    * .rodata — неизменяемые переменные
    * .init — код загрузчика
    * .fin — код финализатора


## **Инструменты для работы с исполняемыми файлами**
1. **Шестнадцатеричный редактор** — программа, которая используется для редактирования или просмотра двоичных данных в шестнадцатеричном представлении.

2. **Дизассемблер** — транслятор, преобразующий машинный код или объектный файл в текст программы на языке ассемблер.

3. **Декомпилятор** — программа, транслирующая исполняемый файл в эквивалентный 	код на языке программирования высокого уровня.

4. **Отладчик** — программа, необходимая для поиска ошибок в программах. Позволяет отслеживать, устанавливать или изменять значения переменных в процессе 	исполнения кода.



## **Radare2**
**Radare2** — кроссплатформенный фреймворк для исследования бинарных файлов. 

**Основные флаги:**
```Shell
$ radare2 -h  
  
--              запуск radare2 без открытия файла  
-a [arch]       выбор архитектуры процессора  
-d              отладка исполняемого файла 'имя_файла' или процесса 'pid'  
-hh             расширенная справка  
-v              отображение версии radare2  
-w              открытие файла в режиме записи  
```

**Формат команд**  
Общий формат команд выглядит следующим образом:
```Shell
[.][times][cmd][~grep][@[@iter]addr!size][|>pipe] ;
```
Чтобы исполнять повторяющиеся команды, необходимо написать префикс команды с количеством повторений:
```Shell
px  # запуск px
3px # хапуск px три раза
```

Стандартный UNIX-пайплайн `|` также доступен в оболочке radare2. Его можно использовать для того, чтобы фильтровать поток данных с помощью таких команд как _grep_, _less_, _wc_. 


### **Анализ** ###
**aa**  Проанализировать все    
**afi** возвращает информацию о функции, в которой мы находимся в данный момент    
**afr**  переименовать функцию: меняет структуру и метку  
  
### **Информация** ###  
**il** информация о файле  
**iz** строки данных в секции  
**izz** строки во всем бинарном файле  
**il** связанные библиотеки  
**ii** импортированные функции  
  
### **Вывод информации** ###
**pdf @offset** вывести дизассемблированную функцию  
  

### **Утилиты, входящие в состав фреймворка** ###
1. **rasm2** - дизассемблер. Позволяет дизассемблировать строки и получить описание опкода.
  
**Перевод опкода в машинный код**
```Shell
$ rasm2 -a x86 nop
90
```
**Дизассемблирование**
```Shell
$ rasm2 -a x86 -d '8d442418'
lea eax, [esp + 0x18]
```
**Описание опкода**
```Shell
$ rasm2 -w mov
moves data from src to dst
```

2. **rabin2** - утилита для работы с исполняемыми файлами. Используется для получения информации о файле.  

**Вывод информации о файле**
```Shell
$ rabin2 -I /bin/ls  
arch     x86  
binsz    128456  
bintype  elf  
bits     64  
canary   true  
class    ELF64  
crypto   false  
endian   little  
havecode true  
intrp    /lib64/ld-linux-x86-64.so.2  
lang     c  
linenum  false  
lsyms    false  
machine  AMD x86-64 architecture  
maxopsz  16  
minopsz  1  
nx       true  
os       linux  
pcalign  0  
pic      true  
relocs   false  
relro    partial  
rpath    NONE  
static   false  
stripped true  
subsys   linux  
va       true  
```

3. **rax2** - утилита для конвертации данных в различных форматах.  

**Перевод из десятичного числа в шестнадцатеричное**
```Shell
$ rax2 100
0X64
```

**Перевод из шестнадцатеричного числа в десятеричное**
```Shell
$ rax2 0xa
10
```

**Таблица ASCII**
```Shell
$ rax2 -a
The following table contains the 128 ASCII characters.

Oct   Dec   Hex   Char                        Oct   Dec   Hex   Char
────────────────────────────────────────────────────────────────────────
000   0     00    NUL '\0' (null character)   100   64    40    @
001   1     01    SOH (start of heading)      101   65    41    A
002   2     02    STX (start of text)         102   66    42    B
003   3     03    ETX (end of text)           103   67    43    C
004   4     04    EOT (end of transmission)   104   68    44    D
005   5     05    ENQ (enquiry)               105   69    45    E
006   6     06    ACK (acknowledge)           106   70    46    F
007   7     07    BEL '\a' (bell)             107   71    47    G
010   8     08    BS  '\b' (backspace)        110   72    48    H
011   9     09    HT  '\t' (horizontal tab)   111   73    49    I
012   10    0A    LF  '\n' (new line)         112   74    4A    J
013   11    0B    VT  '\v' (vertical tab)     113   75    4B    K
...   ...   ...   ... ...                     ...   ...   ...  ...
```

## Полезные ссылки ###
[Ассемблер в Linux](https://ru.wikibooks.org/wiki/%D0%90%D1%81%D1%81%D0%B5%D0%BC%D0%B1%D0%BB%D0%B5%D1%80_%D0%B2_Linux_%D0%B4%D0%BB%D1%8F_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%81%D1%82%D0%BE%D0%B2_C)    
[Справочник команд ассемблера](http://asmworld.ru/spravochnik-komand/)   
[Все об ELF](https://linux-audit.com/elf-binaries-on-linux-understanding-and-analysis/)     
[Radare2 Book](https://radare.gitbooks.io/radare2book/content/)    
[Введение в реверс инжиниринг с Radare2](https://habr.com/company/pentestit/blog/339264/)    
